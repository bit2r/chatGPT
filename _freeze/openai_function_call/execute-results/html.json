{
  "hash": "72f5edee7a3c1648172b328531bc83b0",
  "result": {
    "markdown": "---\ntitle: \"chatGPT\"\nsubtitle: \"OpenAI 함수 호출\"\nauthor:\n  - name: 이광춘\n    url: https://www.linkedin.com/in/kwangchunlee/\n    affiliation: 한국 R 사용자회\n    affiliation-url: https://github.com/bit2r\ntitle-block-banner: true\n#title-block-banner: \"#562457\"\nformat:\n  html:\n    css: css/quarto.css\n    theme: flatly\n    code-fold: true\n    toc: true\n    toc-depth: 3\n    toc-title: 목차\n    number-sections: true\n    highlight-style: github    \n    self-contained: false\nfilters:\n   - lightbox\nlightbox: auto\nlink-citations: true\nknitr:\n  opts_chunk: \n    message: false\n    warning: false\n    collapse: true\n    comment: \"#>\" \n    R.options:\n      knitr.graphics.auto_pdf: true\neditor_options: \n  chunk_output_type: console\nbibliography: bibliography.bib\ncsl: apa-single-spaced.csl    \neditor: \n  markdown: \n    wrap: sentence\n---\n\n\n# API 설정\n\n[[Farzad Mahmoodinobar, \"OpenAI API — Intro & Implementation of the Models Behind ChatGPT - A programmatic approach to use models behind ChatGPT.\"](https://towardsdatascience.com/openai-api-intro-11-practical-implementation-examples-of-the-models-behind-chatgpt-18601f68b51b)]{.aside}\n\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport os\nfrom openai import OpenAI\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nclient = OpenAI(\n    api_key=os.getenv('OPENAI_API_KEY'),\n)\n\nchat_completion = client.chat.completions.create(\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": \"함께 달릴 준비되면 ok, 그렇지 않으면 ko를 출력해줘\",\n        }\n    ],\n    model=\"gpt-3.5-turbo\",\n)\n\n\nprint(chat_completion.choices[0].message.content)\n```\n:::\n\n\n```\nI'm sorry, but I am an AI language model and I cannot physically run or prepare to run with you. However, if you need any advice or information about running, I'll be happy to help.\n```\n\n# 날씨\n\n## 날씨 API\n\n[OpenWeather](https://openweathermap.org/) API를 가져와서 현재 날씨를 가져온다.\n`location`에 서울(seoul)을 넣으면, 서울의 현재 날씨를 가져온다.\n\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport requests \nfrom dotenv import load_dotenv\nimport os\n\nload_dotenv()  # This loads the environment variables from .env\n\n# 현재 날씨를 가져오는 함수를 정의한다.\ndef get_current_weather(location, unit='celsius'):\n    # 여기에 실제 날씨 API로 요청을 보내는 코드를 작성한다.\n    # 예를 들어, OpenWeatherMap API를 사용할 수 있다. (API 키가 필요하다)\n    # API_ENDPOINT는 사용하는 날씨 API의 엔드포인트 URL이다.\n    API_ENDPOINT = 'http://api.openweathermap.org/data/2.5/weather'\n    API_KEY = os.getenv('WEATHER_API_KEY')  # 실제 날씨 API 키\n\n    params = {\n        'q': location,\n        'appid': API_KEY,\n        'units': 'metric' if unit == 'celsius' else 'imperial'\n    }\n    response = requests.get(API_ENDPOINT, params=params)\n    weather_data = response.json()\n    \n    # 가정: weather_data에는 날씨 정보가 JSON 형태로 들어 있다.\n    return weather_data\n\nseoul_weather = get_current_weather(\"seoul\")\n\nprint('현재 온도: ' + str(seoul_weather['main']['temp']) )\n```\n:::\n\n\n```bash\n{'coord': {'lon': 126.9778, 'lat': 37.5683}, 'weather': [{'id': 800, 'main': 'Clear', 'description': 'clear sky', 'icon': '01n'}], 'base': 'stations', 'main': {'temp': 6.51, 'feels_like': 6.51, 'temp_min': 5.66, 'temp_max': 7.69, 'pressure': 1022, 'humidity': 81}, 'visibility': 10000, 'wind': {'speed': 0.51, 'deg': 150}, 'clouds': {'all': 0}, 'dt': 1699449426, 'sys': {'type': 1, 'id': 8105, 'country': 'KR', 'sunrise': 1699394614, 'sunset': 1699432081}, 'timezone': 32400, 'id': 1835848, 'name': 'Seoul', 'cod': 200}\n```\n\n\n## 챗GPT 날씨\n\n챗GPT를 사용하여 서울 날씨를 물어보면 다음과 같이 대답한다.\n현재 서울의 날씨를 직접 확인하지 않고 환영(Halluciation)을 보여주고 있다.\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport os\nimport openai\n\n# OpenAI API를 사용할 준비를 한다.\nOPENAI_API_KEY = os.getenv('OPEN_API_KEY')\nopenai.api_key = OPENAI_API_KEY\n\n# 대화형 챗봇 모형을 이용하여 서울 날씨에 대한 대화를 시작한다.\n\nweather_response = client.chat.completions.create(\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": \"서울 날씨는 어떠하냐?\",\n        }\n    ],\n    model=\"gpt-3.5-turbo\",\n)\n\n\n# 응답 결과를 출력한다.\nprint(weather_response.choices[0].message.content)\n```\n:::\n\n\n```bash\n현재 서울의 날씨는 어린이 날은 보통 맑음입니다. 현재 기온은 약 19도이며, 오늘은 하루 종일 맑은 날씨로 예상됩니다.\n```\n\n\n# Function calling\n\n함수 호출(function calling)을 활용한 사례를 살펴보자. [^function-calling]\n\n[^function-calling]: [David Hundley, \"An Introduction to OpenAI Function Calling - No more unstructured data outputs; turn ChatGPT’s completions into structured JSON!\", Towards Data Science, 2023-07-10](https://medium.com/towards-data-science/an-introduction-to-openai-function-calling-e47e7cd7680e)\n\n## 스크립트\n\n지문을 주어지고 프롬프트 엔지니어링을 통해 필요한 정보만을 추출한다.\n\n\n::: {.cell}\n\n```{.python .cell-code}\nabout_me = 'Hello! My name is David Hundley. I am a principal machine learning engineer at State Farm. I enjoy learning about AI and teaching what I learn back to others. I have two daughters. I drive a Tesla Model 3, and my favorite video game series is The Legend of Zelda.'\n\nabout_me_prompt = f'''\nPlease extract information as a JSON object. Please look for the following pieces of information.\nName\nJob title\nCompany\nNumber of children as a single integer\nCar make\nCar model\nFavorite video game series\n\nThis is the body of text to extract the information from:\n{about_me}\n'''\n\nplain_response = client.chat.completions.create(\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": about_me_prompt,\n        }\n    ],\n    model=\"gpt-3.5-turbo\",\n    max_tokens=256\n)\n\n```\n:::\n\n\n## 함수 호출\n\n함수를 정의해서 필요한 정보를 추출한다.\n\n\n::: {.cell}\n\n```{.python .cell-code}\ndef extract_person_info(name, job_title, num_children):\n    '''\n    Prints basic \"About Me\" information\n\n    Inputs:\n        - name (str): Name of the person\n        - job_title (str): Job title of the person\n        - num_chilren (int): The number of children the parent has.\n    '''\n\n    print(f'This person\\'s name is {name}. Their job title is {job_title}, and they have {num_children} children.')\n\ninfo_functions = [\n    {\n        'name': 'extract_person_info',\n        'description': 'Get \"About Me\" information from the body of the input text',\n        'parameters': {\n            'type': 'object',\n            'properties': {\n                'name': {\n                    'type': 'string',\n                    'description': 'Name of the person'\n                },\n                'job_title': {\n                    'type': 'string',\n                    'description': 'Job title of the person'\n                },\n                'num_children': {\n                    'type': 'integer',\n                    'description': 'Number of children the person is a parent to'\n                }\n            }\n        }\n    }\n]\n\n\ninfo_response = client.chat.completions.create(\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": about_me,\n        }\n    ],\n    model=\"gpt-3.5-turbo\",\n    functions = info_functions,\n    function_call = 'auto'    \n)\n\nimport json\n\n# JSON 문자열 예시\njson_str = info_response.choices[0].message.function_call.arguments\n\n# JSON 문자열을 Python 딕셔너리로 변환\ninfo_dict = json.loads(json_str)\n\n# 필요한 정보 추출\nname = info_dict['name']\njob_title = info_dict['job_title']\nnum_children = info_dict['num_children']\n\nprint(f\" Name: {name}\\n Job Title: {job_title}\\n Number of Children: {num_children}\\n\")\n```\n:::\n\n\n\n# LLM 출력결과 \n\n[[Gabriel Cassimiro, \"LLM Output Parsing: Function Calling vs. LangChain - How to consistently parse outputs from LLMs using Open AI API and LangChain function calling: evaluating the methods’ advantages and disadvantages\", Towards Data Science, 2023-09-22](https://medium.com/towards-data-science/llm-output-parsing-function-calling-vs-langchain-63b80545b3a7)]{.aside}\n\nLLM을 활용한 도구 제작에 벡터 데이터베이스, 체인, 에이전트, 문서 분할 등 여러 구성 요소가 필요하지만, 가장 중요한 구성 요소 중 하나는 **LLM 출력 파싱(parsing)**이다. LLM에서 구조화된 응답결과를 전달받지 못하면 후속 작업에 어려움이 크다.\n\n## 프롬프트 공학\n\nf-string을 사용해서 API 호출 결과를 텍스트로 출력한다. \n따라서, 별도 후처리가 필요하다.\n\n\n::: {.cell}\n\n```{.python .cell-code}\nrecipe = 'Fish and chips'\nquery = f\"\"\"What is the recipe for {recipe}? Return the ingredients list and steps separately.\"\"\"\n\ncook_response = client.chat.completions.create(\n  messages = [\n    {\n          \"role\": \"system\",\n          \"content\": \"You are the best cook in the world.\" \n      \n    },\n    {\n        \"role\": \"user\",\n        \"content\": query\n    }\n  ],\n  model=\"gpt-3.5-turbo\",\n  max_tokens=256,\n  temperature=0\n)\n\nprint(cook_response.choices[0].message.content)\n```\n:::\n\n\n```\nIngredients for Fish and Chips:\n- 1 lb white fish fillets (such as cod or haddock)\n- 1 cup all-purpose flour\n- 1 tsp baking powder\n- 1 tsp salt\n- 1/2 tsp black pepper\n- 1 cup cold sparkling water\n- Vegetable oil, for frying\n- 4 large potatoes, peeled and cut into thick fries\n- Salt, to taste\n\nSteps for Fish:\n1. In a shallow dish, mix together flour, baking powder, salt, and black pepper.\n2. Dip each fish fillet into the flour mixture, coating it evenly on both sides.\n3. Heat vegetable oil in a deep frying pan or pot over medium-high heat.\n4. Carefully place the coated fish fillets into the hot oil and fry for about 4-5 minutes on each side, or until golden brown and crispy.\n5. Once cooked, remove the fish from the oil and place on a paper towel-lined plate to drain excess oil.\n\nSteps for Chips:\n1. Rinse the cut potato fries under cold water to remove excess starch.\n2. In a large pot, heat vegetable oil over medium-high heat until it reaches about 350°F (175°C).\n3. Carefully add the potato\n```\n\n## 함수 호출\n\n함수 호출(function calling) 기능을 사용하면 출력결과를 나눠 구별할 수 있다. 텍스트 형식으로 요리재료와 요리절차가 함께 출력되어 이를 재활용하는데 어려움이 크다. 함수 호출을 사용해서 이러한 문제를 해결해보자.\n\n\n::: {.cell}\n\n```{.python .cell-code}\ncook_funciton = [\n    {\n        \"name\": \"return_recipe\",\n        \"description\": \"Return the recipe asked\",\n        \"parameters\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"ingredients\": {\n                    \"type\": \"string\",\n                    \"description\": \"The ingredients list.\"\n                },\n                \"steps\": {\n                    \"type\": \"string\",\n                    \"description\": \"The recipe steps.\"\n                },\n            },\n            },\n            \"required\": [\"ingredients\",\"steps\"],\n        }\n]\n\nrecipe_response = client.chat.completions.create(\n    messages=[\n        {\n            \"role\": \"user\",\n            \"content\": query,\n        }\n    ],\n    model=\"gpt-3.5-turbo\",\n    functions = cook_funciton,\n    function_call = 'auto'    \n)\n\n# JSON 문자열 예시\nrecipe_json = recipe_response.choices[0].message.function_call.arguments\n\nimport json\n\n# JSON 문자열을 Python 딕셔너리로 변환\nrecipe_dict = json.loads(recipe_json)\n\n# 필요한 정보 추출\nrecipe_ingredients = recipe_dict['ingredients']\nrecipe_steps = recipe_dict['steps']\n\nprint(f\"재료: \\n{recipe_ingredients}\\n\\n요리절차: \\n{recipe_steps}\")\n\n```\n:::\n\n\n```\n재료: \nFish\nPotatoes\nFlour\nSalt\nPepper\nBaking powder\nMilk\nBeer\nVegetable oil\n\n요리절차: \n1. Slice potatoes into fries\n2. Mix flour, salt, pepper, and baking powder\n3. Add milk and beer to flour mixture\n4. Dip fish into batter\n5. Fry fish and fries in vegetable oil until golden brown\n```\n\n## JSON 출력\n\nOpenAI 개발자 컨퍼런스에서 새롭게 소개된 JSON 출력을 지원하는 기능을 사용한다. [^openai_json]\n\n[^openai_json]: [Jake Cyr, \"Extracting Structured Wisdom: Leveraging OpenAI’s New JSON Feature for Enhanced Data Interpretation\",Artificial Intelligence in Plain English, 2023-11-12](https://medium.com/ai-in-plain-english/extracting-structured-wisdom-leveraging-openais-new-json-feature-for-enhanced-data-interpretation-2a1161ce301e)\n\n\n::: {.cell}\n\n```{.python .cell-code}\njson_response = client.chat.completions.create(\n    model=\"gpt-3.5-turbo-1106\", # \"gpt-4-1106-preview\",\n    messages=[\n        {\n            \"role\": \"system\",\n            \"content\": \"You are the best cook in the world. Your response should be in JSON format.\",\n        },\n        {\n            \"role\": \"user\",\n            \"content\": query,\n        }\n    ],\n    response_format={ \"type\": \"json_object\" }\n)\n\n# JSON 문자열 예시\nrecipe_gpt_json = json_response.choices[0].message.content\n\nimport json\nrecipe_dict = json.loads(recipe_gpt_json)\n\nprint(recipe_dict['recipe']['name'])\n# Fish and Chips\nprint(recipe_dict['recipe']['ingredients'])\n# {'fish': '2 fillets of cod or haddock', 'potatoes': '4 large potatoes', 'flour': '1 cup', 'baking powder': '2 tsp', 'salt': '1 tsp', 'milk': '1 cup', 'egg': '1', 'oil': 'for frying'}\nprint(recipe_dict['recipe']['steps'])\n# ['Peel and cut the potatoes into thick strips for the chips.', 'Rinse and pat dry the fish fillets. Cut them into manageable pieces.', 'In a bowl, mix together the flour, baking powder, and salt. In another bowl, whisk together the milk and egg.', \"Dip each piece of fish into the flour mixture, then into the milk mixture, and back into the flour mixture, ensuring it's well coated.\", 'Heat the oil in a deep fryer or large pot to 375°F (190°C). Fry the chips until golden and crispy, then remove and drain on paper towels.', 'Reheat the oil to 350°F (175°C). Fry the fish pieces for 4-5 minutes until they are golden and crispy. Drain on paper towels.', 'Serve the fish and chips hot, with sides such as tartar sauce, malt vinegar, or lemon wedges.']\n```\n:::\n\n\n\n:::{.callout-note}\n\n프롬프트에 항상 \"JSON\" 용어를 추가해야만 JSON 출력결과를 얻을 수 있다.\n\n```\nopenai.BadRequestError: Error code: 400 - {'error': {'message': \"'messages' must contain the word 'json' in some form, to use 'response_format' of type 'json_object'.\", 'type': 'invalid_request_error', 'param': 'messages', 'code': None}}\n```\n\n:::\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}