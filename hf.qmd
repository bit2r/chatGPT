---
title: "chatGPT"
subtitle: "Hugging Face"
author:
  - name: ì´ê´‘ì¶˜
    url: https://www.linkedin.com/in/kwangchunlee/
    affiliation: í•œêµ­ R ì‚¬ìš©ìíšŒ
    affiliation-url: https://github.com/bit2r
title-block-banner: true
#title-block-banner: "#562457"
format:
  html:
    css: css/quarto.css
    theme: flatly
    code-fold: true
    toc: true
    toc-depth: 3
    toc-title: ëª©ì°¨
    number-sections: true
    highlight-style: github    
    self-contained: false
filters:
   - lightbox
   - interview-callout.lua
lightbox: auto
link-citations: true
knitr:
  opts_chunk: 
    message: false
    warning: false
    collapse: true
    comment: "#>" 
    R.options:
      knitr.graphics.auto_pdf: true
editor_options: 
  chunk_output_type: console
---

# íŒŒì´ì¬ ê°€ìƒí™˜ê²½

íŒŒì´ì¬ì„ ê³„ì† ì‚¬ìš©í•˜ë‹¤ë³´ë‹ˆ ë¬´ì¡°ê±´ ê°€ìƒí™˜ê²½ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤ëŠ” ê±¸ ì ˆì‹¤íˆ ëŠë¼ê²Œ ëœë‹¤.
ì‹œê°„ì´ ì§€ë‚˜ë©´ ì–´ë–¤ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í–ˆì—ˆëŠ”ì§€ í™•ì¸ì´ ë˜ì§€ ì•Šê³  ì–´ë–¤ ê²ƒì´ ë¬¸ì œê°€ ë˜ì–´ ì˜ ëŒë˜ ì½”ë“œê°€ ì œëŒ€ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ì§€ íŒŒì•…ì´ í˜ë“œëŠ” ì§€ê²½ì— ì´ë¥´ê²Œ ëœë‹¤.

íŒŒì´ì¬3ì—ì„œ `venv`, `virtualenv` ë‘ê°€ì§€ ê°€ìƒí™˜ê²½ íŒ©í‚¤ì§€ê°€ ì œê³µë˜ëŠ”ë° ì„ íƒì„ í•´ì•¼í•œë‹¤.
ê²°ë¡ ì€ íŒŒì´ì¬3ì—ì„œ `venv`ê°€ ì§€ì›ë˜ë‹ˆ ë³„ë„ íŒ¨í‚¤ì§€ ì„¤ì¹˜ì—†ì´ `venv`ë¡œ ê°€ëŠ” ê²ƒì´ ì¢‹ë‹¤.

1. `python3 -m venv <ê°€ìƒí™˜ê²½ ëª…ì¹­>`
1. `source <ê°€ìƒí™˜ê²½ ëª…ì¹­>/bin/activate` 
1. `pip install -U pip`
1. `pip install pandas`
1. `pip freeze > requirements.txt`

ê°€ìƒí™˜ê²½ ìƒì„±ë¶€í„° ì£¼ìš”í•œ ê°€ìƒí™˜ê²½ ì„¤ì • ë°©ë²•ì„ ìˆœì°¨ì ìœ¼ë¡œ íŒŒì•…í•´ë³´ì.

::: {.panel-tabset}

## ìƒì„±

```bash
py-3.10.9 tidyverse in ~/venv
â—‹ â†’ python3 -m venv venv
```

## í™œì„±í™”

```bash
py-3.10.9 tidyverse in ~/venv
â—‹ â†’ source venv/bin/activate

## .\venv\Scripts\activate ## ìœˆë„ìš°ì¦ˆ
```

## íŒŒì´ì¬

```bash
â—‹ â†’ which python
/Users/tidyverse/venv/venv/bin/python
```

## pip ì„¤ì¹˜

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ pip install -U pip
Requirement already satisfied: pip in ./venv/lib/python3.9/site-packages (21.2.4)
Collecting pip
  Using cached pip-23.0-py3-none-any.whl (2.1 MB)
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 21.2.4
    Uninstalling pip-21.2.4:
      Successfully uninstalled pip-21.2.4
Successfully installed pip-23.0
```

## íŒë‹¤ìŠ¤ ì„¤ì¹˜

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ pip install pandas
Collecting pandas
  Downloading pandas-1.5.3-cp39-cp39-macosx_10_9_x86_64.whl (12.0 MB)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 12.0/12.0 MB 5.7 MB/s eta 0:00:00
Collecting pytz>=2020.1
  Using cached pytz-2022.7.1-py2.py3-none-any.whl (499 kB)
Collecting numpy>=1.20.3
  Downloading numpy-1.24.2-cp39-cp39-macosx_10_9_x86_64.whl (19.8 MB)
     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 19.8/19.8 MB 4.3 MB/s eta 0:00:00
Collecting python-dateutil>=2.8.1
  Using cached python_dateutil-2.8.2-py2.py3-none-any.whl (247 kB)
Collecting six>=1.5
  Using cached six-1.16.0-py2.py3-none-any.whl (11 kB)
Installing collected packages: pytz, six, numpy, python-dateutil, pandas
Successfully installed numpy-1.24.2 pandas-1.5.3 python-dateutil-2.8.2 pytz-2022.7.1 six-1.16.0
```

## freeze

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ pip freeze
numpy==1.24.2
pandas==1.5.3
python-dateutil==2.8.2
pytz==2022.7.1
six==1.16.0
```


## `requirements.txt`

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ pip freeze > requirements.txt
```

## ê°€ìƒí™˜ê²½ êµ¬ì¡°

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ tree -L 2
.
â”œâ”€â”€ requirements.txt
â””â”€â”€ venv
    â”œâ”€â”€ bin
    â”œâ”€â”€ include
    â”œâ”€â”€ lib
    â””â”€â”€ pyvenv.cfg

4 directories, 2 files
```

## `deactivate`

```bash
 |venv|py-3.9.6 tidyverse in ~/venv
â—‹ â†’ deactivate

py-3.10.9 tidyverse in ~/venv
â—‹ â†’
```

:::

# ì „í˜•ì ì¸ í”„ë¡œì íŠ¸

ê²©ë¦¬ëœ íŒŒì´ì¬ ê°œë°œí™˜ê²½ê³¼ ë°ì´í„°, ì½”ë“œ, ipynb ë“±ì´ ëª¨ë‘ ê°–ì¶°ì§„ í”„ë¡œì íŠ¸ 
ë””ë ‰í† ë¦¬ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```bash
project_name/
    venv/
    data/
    code/
        main.py
        module1.py
        module2.py
        ...
    notebooks/
        analysis.ipynb
        exploratory.ipynb
        ...
    requirements.txt
    README.md
```

# NLP ì‘ì—… ë¶„ë¥˜

[`Hugging Face`](https://huggingface.co/) ì›¹ì‚¬ì´íŠ¸ì—ì„œ Transformerë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ ë‹¤ì–‘í•œ ìì—°ì–´ ì²˜ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

ë¨¼ì €, ì‘ì—…íë¦„ì€ ì•ì„œ ì¤€ë¹„í•œ íŒŒì´ì¬ ê°€ìƒí™˜ê²½ì— í—ˆê¹… í˜ì´ìŠ¤ì—ì„œ Transfomerë¥¼ ì„¤ì¹˜í•˜ê³  ì´ì–´ ê° NLP ì‘ì—…(task)ì— ë§ì¶° í›„ì†ì‘ì—…ì„ ì´ì–´ë‚˜ê°„ë‹¤.

[[Hello Transformers from R](https://rpubs.com/eR_ic/transfoRmers)]{.aside}

[[R, Reticulate, and Hugging Face Models](https://cengiz.me/posts/huggingface/)]{.aside}

```{mermaid}
graph LR
    A["venv ê°€ìƒí™˜ê²½"] --> T(("Transformer"))
    B["R reticulate"] --> T(("Transformer"))
    T ---> C["í…ìŠ¤íŠ¸ ë¶„ë¥˜(Text Classification)"]
    T ---> D["ê°œì²´ëª…ì¸ì‹(NER)"]
    T ---> E["ì§ˆì˜ ì‘ë‹µ(Question & Answering)"]
    T ---> F["ìš”ì•½(Summarization)"]
    T ---> G["ë²ˆì—­(Translation)"]
    T ---> H["í…ìŠ¤íŠ¸ ìƒì„±(Text Generation)"]    
    style A fill:#FF6655AA
    style T fill:#88ffFF
```


## í™˜ê²½ ì„¤ì • {-}

íŒŒì´ì¬ ê°€ìƒí™˜ê²½ì„ ì¤€ë¹„í•˜ê³  `transformers` ë° ì—°ê´€ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œë‹¤.

```{r}
#| eval: false
library(reticulate)

use_python("~/venv/venv/bin/python")
reticulate::py_config()
reticulate::py_available()

reticulate::py_install("transformers", pip = TRUE)
reticulate::py_install(c("torch", "sentencepiece"), pip = TRUE)

```

## ê°ì • ë¶„ë¥˜

ì˜ë¬¸ í…ìŠ¤íŠ¸ ê°ì •ì„ ë¶„ë¥˜í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ì.

```{r}
library(reticulate)
library(tidyverse)

use_python("~/venv/venv/bin/python")

text <- ("Dear Amazon, last week I ordered an Optimus Prime action figure from your online store in Germany. Unfortunately, when I opened the package, I discovered to my horror that I had been sent an action figure of Megatron instead! As a lifelong enemy of the Decepticons, I hope you can understand my dilemma. To resolve the issue, I demand an exchange of Megatron for the Optimus Prime figure I ordered. Enclosed are copies of my records concerning this purchase. I expect to hear from you soon. Sincerely, Bumblebee.")

# Importing ğŸ¤— transformers into R session
transformers <- reticulate::import("transformers")

# model_name <- "bert-base-uncased"
# model <- transformers$AutoModel$from_pretrained(model_name)

# Instantiate a pipeline
classifier <- transformers$pipeline(task = "text-classification")

# Generate predictions
outputs <- classifier(text)

# Convert predictions to tibble
outputs %>% 
  pluck(1) %>% 
  as_tibble()
```

## NER

ê°œì²´ëª… ì¸ì‹ì€ í…ìŠ¤íŠ¸ ë‚´ë¶€ì— ì§€ëª…, ì¸ëª…, ì œí’ˆ ë“±ì„ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ëŠ” ê³¼ì •ì´ë‹¤.

```{r}
# Download model for ner task
ner_tagger <- transformers$pipeline(task = "ner", aggregation_strategy = "simple")

# Make predictions
outputs <- ner_tagger(text)

# Convert predictions to tibble
# This takes some bit of effort since some of the variables are numpy objects 

# Function that takes a list element and converts
# it to a character
to_r <- function(idx){
  # Obtain a particular output from entire named list
  output_idx = outputs %>% 
    pluck(idx)
  
  # Convert score from numpy to integer
  output_idx$score = paste(output_idx$score) %>% 
    as.double()
  
  return(output_idx)
  
}

# Convert outputs to tibble
map_dfr(1:length(outputs), ~to_r(.x))
```

## ì§ˆì˜ì‘ë‹µ

í…ìŠ¤íŠ¸ì— ì§ˆë¬¸ì„ ë˜ì§€ê³  í•´ë‹¹ ëŒ€ë‹µì„ ì°¾ì•„ë‚´ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•´ë³´ì.

```{r}
# Specify task
reader <- transformers$pipeline(task = "question-answering")

# Question we want answered
question <-  "What does the customer want?"

# Provide model with question and context
outputs <- reader(question = question, context = text)
outputs %>% 
  as_tibble()
```

## ìš”ì•½

í…ìŠ¤íŠ¸ê°€ ë§¤ìš° ê¸´ ê²½ìš° ì´ë¥¼ ë‹¨ìˆœíˆ ìš”ì•½í•  ìˆ˜ ìˆë‹¤.

```{r}
summarizer <- transformers$pipeline("summarization")
outputs <- summarizer(text, max_length = 56L, clean_up_tokenization_spaces = TRUE)
outputs
```

## ë²ˆì—­

[Language Technology Research Group at the University of Helsinki](https://huggingface.co/Helsinki-NLP) ì—ì„œ ì‚¬ì „í•™ìŠµëª¨í˜•ì„ ë‹¤ìš´ë¡œë“œ ë°›ì•„ ë²ˆì—­ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

```{r}
# This requires python package sentencepiece
sentencepiece <- reticulate::import("sentencepiece")

# Explicitly specifying the model you want
translator <- transformers$pipeline(
  task = "translation",
  model = "Helsinki-NLP/opus-mt-tc-big-en-ko") # model = "Helsinki-NLP/opus-mt-en-de"

outputs <- translator(text, clean_up_tokenization_spaces = TRUE,
                      min_length = 100L)

outputs
```

## í…ìŠ¤íŠ¸ ìƒì„±

ê³ ê°ì´ ë‚¨ê¸´ ê³ ê°ì˜ ì†Œë¦¬ì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ë‹µì›ì´ ì²˜ìŒì„ ì‹œì‘í•˜ë©´ ê¸°ê³„ê°€
ë°˜ì‘ì„ ìë™ìƒì„±ì‹œì¼œ ë‹µì‹ ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```{r}
generator <- transformers$pipeline("text-generation")
response <- "Dear Bumblebee, I am sorry to hear that your order was mixed up."
prompt <- paste(text, "\n\nCustomer service response:\n", response)
outputs <- generator(prompt, max_length = 200L)

outputs %>% 
  pluck(1, "generated_text") %>% 
  cat()
```

## ì°¸ê³ ë¬¸í—Œ

- [Natural Language Processing with Transformers](https://www.oreilly.com/library/view/natural-language-processing/9781098103231/)

-  [Reticulate: R Interface to Python](https://rstudio.github.io/reticulate/index.html)


